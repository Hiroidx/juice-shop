# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker


#trigger:
#- '*'

#resources:
#- repo: self

#variables:
#  tag: '$(Build.BuildId)'

#stages:
#- stage: Build
#  displayName: Build image
#  jobs:
#  - job: Build
#    displayName: Build
#    pool:
#      vmImage: ubuntu-latest
#    steps:
#    - task: Docker@2
#      displayName: Build an image
#      inputs:
#        command: build
#        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
#        tags: |
#          $(tag)

#    - task: PublishBuildArtifacts@1
#      displayName: 'Publish Artifact'
#      inputs:
#        PathtoPublish: '$(build.artifactstagingdirectory)'


# Docker
# Build a Docker image
# https://learn.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- '*'

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'

stages:
- stage: Aproval RQ
  displayName: Aproval RQ
  jobs:
  - deployment: AP
    displayName: AP
    pool:
      vmImage: 'ubuntu-latest'
    environment: Dev

- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - bash: |
        docker build -t hlbuildimage -f Dockerfile .
        docker save hlbuildimage > $(Build.ArtifactStagingDirectory)/docker_image.tar
      displayName: Dockder Build.
    - bash: |
        echo "$(System.AccessToken)" | az devops login --organization https://dev.azure.com/yh8512/
#              az artifacts universal publish --organization https://dev.azure.com/yh8512/ --project='TEST_JuiceShop' --scope project --feed test_feed --name 'juice-shop-dokerimage' --version 0.0.1 --description 'Test Doker Image' --path '$(Build.ArtifactStagingDirectory)/docker_image.tar'
      displayName: Universal publish
    - task: UniversalPackages@0
      displayName: 'Universal publish'
      inputs:
        command: 'publish'
        publishDirectory: '$(Build.ArtifactStagingDirectory)/docker_image.tar'
        vstsFeedPublish: 'TEST_JuiceShop/test_feed'
        vstsFeedPackagePublish: 'docker-image'
        packagePublishDescription: 'Dockerimagefile'

#    - task: PublishBuildArtifacts@1
#      displayName: Publish build artifacts
#      inputs:
#        PathtoPublish: '$(Build.ArtifactStagingDirectory)/docker_image.tar'
#        ArtifactName: 'docker_image'
#        publishLocation: 'Container'

